---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Bio-Optical Model

This is a test. 

```{r}
my_aq_site <- 'BARC'
my_aop_yr <- '2019
```

## Reflectance Spectra

```{r}
spectra_dir <- "/Volumes/hondula/DATA/spectra_buff5m"
spectra_file <- fs::dir_ls(spectra_dir, regexp = glue("{my_aq_site}_{my_aop_yr}"))

spectra_df <- read_csv(spectra_file)
my_spectra_pt <- spectra_df %>% filter(my_cellid)

spectra_df %>%
  ggplot(aes(wavelength, reflectance)) +
  geom_line(aes(group = cell)) +
  geom_line(data = my_spectra_pt, col = "green", lwd = 1) +
  theme_bw() +
  coord_cartesian(ylim = c(0, 0.1)) +
  theme(legend.position = "none")

```

```{r}
my_wavelengths_rs <- my_spectra_pt$wavelength
```

## Water Spectra

```{r}
water3 <- read_excel("../../data/water-spectra/water-spectra-buiteveld94.xlsx")

abs_water = data.frame(wl = water3$lambda_nm,
                       absorb_m1 = water3$absorption_m1)

backs_water = data.frame(wl = water3$lambda_nm,
                         backs_m1 = water3$scattering_m1)

aa <- ggplot(backs_water, aes(x = wl, y = backs_m1)) + 
  geom_point() + 
  geom_vline(aes(xintercept = my_wavelengths[1])) +
  geom_vline(aes(xintercept = my_wavelengths[100]))

bb <- ggplot(abs_water, aes(x = wl, y = absorb_m1)) + 
  geom_point() +
  geom_vline(aes(xintercept = my_wavelengths[1])) +
  geom_vline(aes(xintercept = my_wavelengths[100]))

cowplot::plot_grid(aa, bb)

```

Can only model up to 800 nm based on extent of absorbance and backscattering
spectra for water. 

Need to interpolate water spectra to wavelengths of rs data. 
For now model abs and backs based on water wavelengths

Convert to list so abs_water[[300]] is value? 

```{r}

abs_water_list <- dplyr::select(abs_water, absorb_m1) %>% 
  purrr::transpose(.names = glue('wl{abs_water$wl}'))
abs_water_list$wl300

backs_water_list <- dplyr::select(backs_water, backs_m1) %>% 
  purrr::transpose(.names = glue('wl{backs_water$wl}'))
backs_water_list$wl300

my_wavelengths_water <- abs_water %>% 
  filter(wl %in% seq(range(my_wavelengths_rs)[1], range(my_wavelengths_rs)[2])) %>%
  pull(wl)

backs_water_list[["wl402"]]
abs_water_list[["wl402"]]

```



## Solar zenith angle

```{r}
zenith_dir <- "/Volumes/hondula/DATA/zenith-angles/"
zenith_file <- fs::dir_ls(zenith_dir, regexp = glue("{my_aq_site}_{my_aop_yr}"))

zenith_df <- read_csv(zenith_file)
my_zenith_pt <- zenith_df %>% filter(my_cellid)

# zenith_df %>%
#   ggplot(aes(x = to_sensor_zenith_angle)) +
#   geom_histogram(binwidth = 0.1, col = "black", fill = "gray") +
#   geom_vline(aes(xintercept = my_zenith_pt$to_sensor_zenith_angle), col = "red") +
#   theme_bw()

mu0 <- cos(my_zenith_pt$to_sensor_zenith_angle)
mu0
```

## Flight metadata

Dates of flights

```{r}
my_aop_dates <- "../neon-sites/results/sites_join_aop_dates.csv" %>%
  readr::read_csv(col_types = "ccccccccddD") %>%
  dplyr::filter(siteID %in% my_aq_site, year %in% my_aop_yr) %>%
  dplyr::select(domanID, siteID, aop_site_id, flightdate) %>%
  distinct()
my_aop_dates
```

Time of pixel acquisition from L1 radiance data

```{r}
radtimes_dir <- "/Volumes/hondula/DATA/radiance-time/"
radtimes_file <- fs::dir_ls(radtimes_dir, regexp = glue("{my_aq_site}-{my_aop_yr}"))
radtimes_df <- read_csv(radtimes_file) %>% dplyr::filter(!is.na(gps_time))
my_radtime <- radtimes_df$datetime
my_radtime
```


## Phytoplankton Absorbance

chl conc (mg/L) * specific absorption

## CDOM absorbance


## Non-algal suspended matter absorbance

suspended matter conc (mg/L) * specific absorption

## Phytoplankton backscattering

## Model 

```{r}
# abs_phyto[] = 
# absorb = abs_water[] + abs_phyto[] + abs_cdom[] + abs_sm[]

```

```{r}
C_mu0 = -0.629 * mu0 + 0.975
surface_factor = 0.544

```




